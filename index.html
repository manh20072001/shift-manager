<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-i18n="appTitle">Shift Manager</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#89CFF0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2370/2370264.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary-color: #89CFF0; --primary-dark: #5ca0c4; --text-color: #333; --bg-color: #f2f4f8; --card-bg: white; --border-color: #ddd; --sunday-color: #ff4d4d; --saturday-color: #3366ff; --shift-bg: #e3f2fd; --shift-text: #1565c0; --nav-inactive: #999; }
        body.dark-mode { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --border-color: #333; --shift-bg: #2c3e50; --shift-text: #89CFF0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .container { flex: 1; overflow-y: auto; padding-bottom: 80px; max-width: 450px; margin: 0 auto; width: 100%; background-color: var(--card-bg); box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        header { background-color: var(--primary-color); color: white; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid var(--border-color); }
        .calendar-day-head { text-align: center; padding: 10px 0; font-weight: bold; font-size: 0.8rem; background: #f8f9fa; }
        body.dark-mode .calendar-day-head { background: #2a2a2a; }
        .calendar-day-head:nth-child(1) { color: var(--sunday-color); }
        .calendar-day-head:nth-child(7) { color: var(--saturday-color); }
        .calendar-day { min-height: 85px; border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); padding: 5px; cursor: pointer; position: relative; }
        .calendar-day:nth-child(7n) { border-right: none; }
        .day-number { font-weight: bold; font-size: 0.9rem; }
        .selected-day { background-color: #e3f2fd !important; outline: 2px solid var(--primary-color); z-index: 1; }
        body.dark-mode .selected-day { background-color: #2c3e50 !important; }
        .shift-info { background: var(--shift-bg); color: var(--shift-text); font-size: 0.6rem; padding: 2px; border-radius: 3px; margin-top: 3px; text-align: center; }
        .wage-info { font-size: 0.65rem; color: #2e7d32; font-weight: bold; text-align: center; margin-top: 2px; }
        body.dark-mode .wage-info { color: #81c784; }
        .daily-detail-card { margin: 15px; padding: 15px; border-radius: 12px; background: #f8f9fa; border: 1px solid var(--border-color); }
        body.dark-mode .daily-detail-card { background: #2a2a2a; }
        .detail-memo { margin-top: 10px; font-size: 0.9rem; color: #666; font-style: italic; white-space: pre-wrap; border-top: 1px dashed #ccc; padding-top: 8px; }
        .settings-card { background: var(--bg-color); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        body.dark-mode .settings-card { background: #1e1e1e; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .setting-row:last-child { border-bottom: none; }
        .setting-input { padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); width: 110px; text-align: right; background: var(--card-bg); color: var(--text-color); }
        nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 450px; height: 65px; background: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--nav-inactive); text-decoration: none; font-size: 0.75rem; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: var(--card-bg); margin: 10% auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 12px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-save { background: var(--primary-color); color: white; }
        .btn-delete { background: #ff4d4d; color: white; }
        .btn-cancel { background: #eee; color: #333; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div data-i18n="appTitle">Shift Manager</div>
        <div id="monthDisplay">2026/02</div>
    </header>

    <div id="calendar-screen" class="screen">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)" class="btn-cancel" style="padding: 5px 15px;">&lt;</button>
            <div id="calendarTitle" style="font-weight: bold;"></div>
            <button onclick="changeMonth(1)" class="btn-cancel" style="padding: 5px 15px;">&gt;</button>
        </div>
        <div class="calendar-grid">
            <div class="calendar-day-head">CN</div><div class="calendar-day-head">T2</div><div class="calendar-day-head">T3</div><div class="calendar-day-head">T4</div><div class="calendar-day-head">T5</div><div class="calendar-day-head">T6</div><div class="calendar-day-head">T7</div>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
        <div class="daily-detail-card">
            <div id="selectedDateLabel" style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);"></div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="dayShiftText"></span>
                <button class="btn-save" style="padding: 8px 15px; border-radius: 20px; font-size: 0.8rem;" onclick="openModal()">Sửa / Ghi chú</button>
            </div>
            <div id="dayMemoText" class="detail-memo"></div>
        </div>
    </div>

    <div id="stats-screen" class="screen hidden" style="padding: 15px;">
        <h3 data-i18n="monthlyStats">Thống kê tháng</h3>
        <div id="statsContent" style="background: var(--primary-color); color:white; padding: 20px; border-radius: 12px; margin-bottom: 15px;"></div>
    </div>

    <div id="settings-screen" class="screen hidden" style="padding: 20px;">
        <h3 data-i18n="settings">Cài đặt</h3>
        <div class="settings-card">
            <div class="setting-row">
                <span data-i18n="hourlyWage">Lương/giờ cơ bản</span>
                <input type="number" id="defaultWage" class="setting-input" onchange="saveSettings()">
            </div>
            <div class="setting-row">
                <span data-i18n="nightWage">Phụ cấp ca đêm (%)</span>
                <input type="number" id="nightWage" class="setting-input" onchange="saveSettings()">
            </div>
            <div class="setting-row">
                <span data-i18n="overtimeWage">Hệ số tăng ca (VD: 1.25)</span>
                <input type="number" id="overtimeWage" step="0.01" class="setting-input" onchange="saveSettings()">
            </div>
            <div class="setting-row">
                <span data-i18n="nightStart">Bắt đầu ca đêm</span>
                <input type="time" id="nightStart" class="setting-input" onchange="saveSettings()">
            </div>
            <div class="setting-row">
                <span data-i18n="nightEnd">Kết thúc ca đêm</span>
                <input type="time" id="nightEnd" class="setting-input" onchange="saveSettings()">
            </div>
        </div>
        <div class="settings-card">
            <div class="setting-row">
                <span>Ngôn ngữ / 言語</span>
                <select id="langSelect" class="setting-input" onchange="changeLang(this.value)">
                    <option value="vi">Tiếng Việt</option>
                    <option value="ja">日本語</option>
                </select>
            </div>
        </div>
    </div>
</div>

<nav>
    <a href="javascript:void(0)" class="nav-item active" onclick="switchScreen('calendar', this)"><i class="fas fa-calendar-alt"></i><span data-i18n="navCalendar">Lịch</span></a>
    <a href="javascript:void(0)" class="nav-item" onclick="switchScreen('stats', this)"><i class="fas fa-chart-bar"></i><span data-i18n="navStats">Thống kê</span></a>
    <a href="javascript:void(0)" class="nav-item" onclick="switchScreen('settings', this)"><i class="fas fa-cog"></i><span data-i18n="navSettings">Cài đặt</span></a>
</nav>

<div id="shiftModal" class="modal">
    <div class="modal-content">
        <h3 id="modalDate" style="text-align:center;"></h3>
        <div class="form-group"><label data-i18n="startTime">Bắt đầu</label><input type="time" id="startTimeInput"></div>
        <div class="form-group"><label data-i18n="endTime">Kết thúc</label><input type="time" id="endTimeInput"></div>
        <div class="form-group"><label data-i18n="breakTime">Nghỉ (phút)</label><input type="number" id="breakTimeInput"></div>
        <div class="form-group"><label data-i18n="memo">Ghi chú</label><textarea id="memoInput" rows="3"></textarea></div>
        <div class="btn-group">
            <button class="btn btn-save" onclick="saveShift()">Lưu</button>
            <button class="btn btn-delete" onclick="deleteShift()">Xóa</button>
            <button class="btn btn-cancel" onclick="closeModal()">Hủy</button>
        </div>
    </div>
</div>

<script>
    // PWA Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); });
    }

    let shiftData = JSON.parse(localStorage.getItem('shiftData')) || {};
    let appSettings = JSON.parse(localStorage.getItem('appSettings')) || { 
        defaultWage: 1100, nightWage: 25, overtimeWage: 1.25, 
        nightStart: '22:00', nightEnd: '05:00', lang: 'vi' 
    };

    let currentYear = new Date().getFullYear(), currentMonth = new Date().getMonth();
    let selectedDate = new Date().toISOString().split('T')[0];

    const translations = {
        vi: { appTitle: "Quản lý ca làm", navCalendar: "Lịch", navStats: "Thống kê", navSettings: "Cài đặt", settings: "Cài đặt", monthlyStats: "Thống kê tháng", hourlyWage: "Lương cơ bản", nightWage: "Phụ cấp đêm (%)", overtimeWage: "Hệ số tăng ca", nightStart: "Bắt đầu đêm", nightEnd: "Kết thúc đêm", startTime: "Bắt đầu", endTime: "Kết thúc", breakTime: "Nghỉ (phút)", save: "Lưu", delete: "Xóa", cancel: "Hủy", totalWage: "Tổng lương", totalHours: "Tổng giờ", noShift: "Nghỉ", memo: "Ghi chú" },
        ja: { appTitle: "シフト管理", navCalendar: "カレンダー", navStats: "統計", navSettings: "設定", settings: "設定", monthlyStats: "月間統計", hourlyWage: "時給", nightWage: "深夜手当(%)", overtimeWage: "残業手当", nightStart: "深夜開始", nightEnd: "深夜終了", startTime: "開始", endTime: "終了", breakTime: "休憩", save: "保存", delete: "削除", cancel: "キャンセル", totalWage: "合計給与", totalHours: "合計時間", noShift: "休み", memo: "メモ" }
    };

    function timeToMin(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }

    function calculateExactWage(s) {
        let sMin = timeToMin(s.start), eMin = timeToMin(s.end);
        if (eMin < sMin) eMin += 1440;
        const totalMin = eMin - sMin - s.break;
        if (totalMin <= 0) return 0;

        const nStartMin = timeToMin(appSettings.nightStart);
        const nEndMin = timeToMin(appSettings.nightEnd) + (timeToMin(appSettings.nightEnd) < nStartMin ? 1440 : 0);
        
        let nightMin = 0;
        for (let m = sMin; m < eMin; m++) {
            let curr = m % 1440;
            let checkEnd = timeToMin(appSettings.nightEnd);
            if (timeToMin(appSettings.nightStart) > checkEnd) {
                if (curr >= timeToMin(appSettings.nightStart) || curr < checkEnd) nightMin++;
            } else {
                if (curr >= timeToMin(appSettings.nightStart) && curr < checkEnd) nightMin++;
            }
        }
        // Giảm trừ thời gian nghỉ vào ca đêm (ước tính tỉ lệ)
        const nightRatio = nightMin / (eMin - sMin);
        const netNightMin = nightMin - (s.break * nightRatio);

        const basePay = (totalMin / 60) * appSettings.defaultWage;
        const nightExtra = (netNightMin / 60) * appSettings.defaultWage * (appSettings.nightWage / 100);
        return Math.round(basePay + nightExtra);
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        document.getElementById('calendarTitle').innerText = `${currentYear}/${currentMonth + 1}`;
        document.getElementById('monthDisplay').innerText = `${currentYear}/${currentMonth + 1}`;

        for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day' + (dateStr === selectedDate ? ' selected-day' : '');
            dayDiv.innerHTML = `<div class="day-number">${d}</div>`;
            if (shiftData[dateStr]) {
                dayDiv.innerHTML += `<div class="shift-info">${shiftData[dateStr].start}-${shiftData[dateStr].end}</div>`;
                dayDiv.innerHTML += `<div class="wage-info">¥${calculateExactWage(shiftData[dateStr]).toLocaleString()}</div>`;
            }
            dayDiv.onclick = () => { selectedDate = dateStr; renderCalendar(); updateDetail(); };
            grid.appendChild(dayDiv);
        }
    }

    function updateDetail() {
        const s = shiftData[selectedDate];
        document.getElementById('selectedDateLabel').innerText = selectedDate;
        if(s) {
            document.getElementById('dayShiftText').innerText = `${s.start} - ${s.end} (¥${calculateExactWage(s).toLocaleString()})`;
            document.getElementById('dayMemoText').innerText = s.memo || "";
        } else {
            document.getElementById('dayShiftText').innerText = translations[appSettings.lang].noShift;
            document.getElementById('dayMemoText').innerText = "";
        }
    }

    function switchScreen(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id + '-screen').classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(id === 'stats') updateStats();
    }

    function updateStats() {
        let totalW = 0, totalH = 0;
        const monthPrefix = `${currentYear}-${String(currentMonth + 1).padStart(2,'0')}`;
        Object.keys(shiftData).forEach(d => {
            if(d.startsWith(monthPrefix)) {
                totalW += calculateExactWage(shiftData[d]);
                const s = shiftData[d];
                let dur = timeToMin(s.end) - timeToMin(s.start);
                if(dur < 0) dur += 1440;
                totalH += (dur - s.break)/60;
            }
        });
        document.getElementById('statsContent').innerHTML = `
            <div style="font-size:0.9rem; opacity:0.9">${translations[appSettings.lang].totalHours}</div>
            <div style="font-size:1.8rem; font-weight:bold; margin-bottom:10px">${totalH.toFixed(2)} h</div>
            <div style="font-size:0.9rem; opacity:0.9">${translations[appSettings.lang].totalWage}</div>
            <div style="font-size:1.8rem; font-weight:bold">¥ ${totalW.toLocaleString()}</div>
        `;
    }

    function openModal() {
        const s = shiftData[selectedDate] || { start: "09:00", end: "17:00", break: 60, memo: "" };
        document.getElementById('modalDate').innerText = selectedDate;
        document.getElementById('startTimeInput').value = s.start;
        document.getElementById('endTimeInput').value = s.end;
        document.getElementById('breakTimeInput').value = s.break;
        document.getElementById('memoInput').value = s.memo;
        document.getElementById('shiftModal').style.display = 'block';
    }

    function closeModal() { document.getElementById('shiftModal').style.display = 'none'; }

    function saveShift() {
        shiftData[selectedDate] = {
            start: document.getElementById('startTimeInput').value,
            end: document.getElementById('endTimeInput').value,
            break: parseInt(document.getElementById('breakTimeInput').value) || 0,
            memo: document.getElementById('memoInput').value
        };
        localStorage.setItem('shiftData', JSON.stringify(shiftData));
        closeModal(); renderCalendar(); updateDetail();
    }

    function deleteShift() {
        delete shiftData[selectedDate];
        localStorage.setItem('shiftData', JSON.stringify(shiftData));
        closeModal(); renderCalendar(); updateDetail();
    }

    function saveSettings() {
        appSettings.defaultWage = parseInt(document.getElementById('defaultWage').value);
        appSettings.nightWage = parseInt(document.getElementById('nightWage').value);
        appSettings.overtimeWage = parseFloat(document.getElementById('overtimeWage').value);
        appSettings.nightStart = document.getElementById('nightStart').value;
        appSettings.nightEnd = document.getElementById('nightEnd').value;
        localStorage.setItem('appSettings', JSON.stringify(appSettings));
        renderCalendar();
    }

    function changeMonth(step) {
        currentMonth += step;
        if(currentMonth < 0) { currentMonth = 11; currentYear--; }
        if(currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendar();
    }

    function changeLang(l) {
        appSettings.lang = l;
        localStorage.setItem('appSettings', JSON.stringify(appSettings));
        location.reload();
    }

    window.onload = () => {
        document.getElementById('defaultWage').value = appSettings.defaultWage;
        document.getElementById('nightWage').value = appSettings.nightWage;
        document.getElementById('overtimeWage').value = appSettings.overtimeWage;
        document.getElementById('nightStart').value = appSettings.nightStart;
        document.getElementById('nightEnd').value = appSettings.nightEnd;
        document.getElementById('langSelect').value = appSettings.lang;
        
        // Apply translations
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[appSettings.lang][key]) el.innerText = translations[appSettings.lang][key];
        });

        renderCalendar(); updateDetail();
    };
</script>
</body>
</html>
