<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-i18n="appTitle">Shift Manager</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#89CFF0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2370/2370264.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* [Giữ nguyên toàn bộ CSS cũ của bạn ở đây] */
        :root { --primary-color: #89CFF0; --primary-dark: #5ca0c4; --text-color: #333; --bg-color: #f2f4f8; --card-bg: white; --border-color: #ddd; --sunday-color: #ff4d4d; --saturday-color: #3366ff; --shift-bg: #e3f2fd; --shift-text: #1565c0; --nav-inactive: #999; --calc-clear: #a5a5a5; --calc-operator: #ff9f0a; --calc-number: #333333; }
        body.dark-mode { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --border-color: #333; --shift-bg: #2c3e50; --shift-text: #89CFF0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .container { flex: 1; overflow-y: auto; padding-bottom: 80px; max-width: 450px; margin: 0 auto; width: 100%; background-color: var(--card-bg); box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        header { background-color: var(--primary-color); color: white; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.3s; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid var(--border-color); }
        .calendar-day-head { text-align: center; padding: 10px 0; font-weight: bold; font-size: 0.8rem; background: #f8f9fa; }
        body.dark-mode .calendar-day-head { background: #2a2a2a; }
        .calendar-day-head:nth-child(1) { color: var(--sunday-color); }
        .calendar-day-head:nth-child(7) { color: var(--saturday-color); }
        .calendar-day { min-height: 80px; border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); padding: 5px; cursor: pointer; }
        .calendar-day:nth-child(7n) { border-right: none; }
        .day-number { font-weight: bold; font-size: 0.9rem; }
        .selected-day { background-color: #e3f2fd !important; outline: 2px solid var(--primary-color); }
        body.dark-mode .selected-day { background-color: #2c3e50 !important; }
        .shift-info { background: var(--shift-bg); color: var(--shift-text); font-size: 0.6rem; padding: 2px; border-radius: 3px; margin-top: 3px; }
        .wage-info { font-size: 0.6rem; color: #2e7d32; font-weight: bold; }
        body.dark-mode .wage-info { color: #81c784; }
        .daily-detail-card { margin: 15px; padding: 15px; border-radius: 12px; background: #f8f9fa; border: 1px solid var(--border-color); }
        body.dark-mode .daily-detail-card { background: #2a2a2a; }
        .detail-memo { margin-top: 10px; font-size: 0.9rem; color: #555; font-style: italic; white-space: pre-wrap; border-top: 1px dashed #ccc; padding-top: 8px; }
        .settings-card { background: var(--bg-color); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        body.dark-mode .settings-card { background: #1e1e1e; }
        .profile-container { display: flex; align-items: center; gap: 15px; }
        .avatar-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .setting-input { padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); width: 100px; text-align: right; background: var(--card-bg); color: var(--text-color); }
        .calculator-container { padding: 15px; background: #000; border-radius: 20px; margin: 10px; }
        #calcDisplay { width: 100%; height: 60px; font-size: 2rem; text-align: right; border: none; background: transparent; color: white; outline: none; }
        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calc-btn { height: 55px; border-radius: 28px; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .btn-number { background: var(--calc-number); color: white; }
        .btn-operator { background: var(--calc-operator); color: white; }
        .btn-special { background: var(--calc-clear); color: black; }
        nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 450px; height: 65px; background: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--nav-inactive); text-decoration: none; font-size: 0.7rem; }
        .nav-item.active { color: var(--primary-color); }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: var(--card-bg); margin: 10% auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 12px; max-height: 85vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); font-size: 1rem; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-save { background: var(--primary-color); color: white; }
        .btn-delete { background: #ff4d4d; color: white; }
        .btn-cancel { background: #eee; color: #333; }
        .hidden { display: none; }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(18px); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div data-i18n="appTitle">Shift Manager</div>
        <div id="monthDisplay">2026/02</div>
    </header>

    <div id="calendar-screen" class="screen">
        <div class="calendar-header">
            <button id="prevMonth" class="btn-cancel" style="padding: 5px 15px;">&lt;</button>
            <div id="calendarTitle" style="font-weight: bold;">2026/02</div>
            <button id="nextMonth" class="btn-cancel" style="padding: 5px 15px;">&gt;</button>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
        <div class="daily-detail-card">
            <div id="selectedDateLabel" style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);"></div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="dayShiftText"></span>
                <button class="btn-save" style="padding: 5px 15px; border-radius: 20px; font-size: 0.8rem;" onclick="openModalFromDetail()" data-i18n="editMemo">Sửa</button>
            </div>
            <div id="dayMemoText" class="detail-memo"></div>
        </div>
    </div>

    <div id="stats-screen" class="screen hidden" style="padding: 15px;">
        <h3 data-i18n="monthlyStats">Thống kê</h3>
        <div id="statsContent" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--border-color);"></div>
        <div class="calculator-container">
            <input type="text" id="calcDisplay" readonly placeholder="0">
            <div class="calculator-grid">
                <button class="calc-btn btn-special" onclick="appendCalc('C')">C</button>
                <button class="calc-btn btn-special" onclick="appendCalc('+/-')">+/-</button>
                <button class="calc-btn btn-special" onclick="appendCalc('%')">%</button>
                <button class="calc-btn btn-operator" onclick="appendCalc('/')">÷</button>
                <button class="calc-btn btn-number" onclick="appendCalc('7')">7</button>
                <button class="calc-btn btn-number" onclick="appendCalc('8')">8</button>
                <button class="calc-btn btn-number" onclick="appendCalc('9')">9</button>
                <button class="calc-btn btn-operator" onclick="appendCalc('*')">×</button>
                <button class="calc-btn btn-number" onclick="appendCalc('4')">4</button>
                <button class="calc-btn btn-number" onclick="appendCalc('5')">5</button>
                <button class="calc-btn btn-number" onclick="appendCalc('6')">6</button>
                <button class="calc-btn btn-operator" onclick="appendCalc('-')">−</button>
                <button class="calc-btn btn-number" onclick="appendCalc('1')">1</button>
                <button class="calc-btn btn-number" onclick="appendCalc('2')">2</button>
                <button class="calc-btn btn-number" onclick="appendCalc('3')">3</button>
                <button class="calc-btn btn-operator" onclick="appendCalc('+')">+</button>
                <button class="calc-btn btn-number" style="grid-column: span 2; text-align: left; padding-left: 25px;" onclick="appendCalc('0')">0</button>
                <button class="calc-btn btn-number" onclick="appendCalc('.')">.</button>
                <button class="calc-btn btn-operator" onclick="calculateResult()">=</button>
            </div>
        </div>
    </div>

    <div id="settings-screen" class="screen hidden" style="padding: 20px;">
        <h3 data-i18n="settings">Cài đặt</h3>
        <div class="settings-card">
            <div class="profile-container">
                <img src="https://via.placeholder.com/60" id="avatarImg" class="avatar-img">
                <div class="profile-info">
                    <input type="text" id="profileName" placeholder="Tên" onchange="saveProfile()" style="border:none; border-bottom:1px solid #ddd; width:100%;">
                </div>
            </div>
        </div>
        <div class="settings-card">
            <div class="setting-row">
                <span data-i18n="language">Ngôn ngữ</span>
                <select id="langSelect" class="setting-input" style="width: auto;">
                    <option value="ja">日本語</option><option value="en">English</option><option value="vi">Tiếng Việt</option>
                </select>
            </div>
            <div class="setting-row">
                <span data-i18n="darkMode">Chế độ tối</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-row">
                <span data-i18n="hourlyWage">Lương/giờ cơ bản</span>
                <input type="number" id="defaultWage" class="setting-input" onchange="saveSettings()">
            </div>
            <div class="setting-row">
                <span data-i18n="nightWage">Ca đêm (+%)</span>
                <input type="number" id="nightWage" class="setting-input" onchange="saveSettings()">
            </div>
        </div>
    </div>
</div>

<nav>
    <a href="#" class="nav-item active" onclick="switchScreen('calendar')"><i class="fas fa-calendar-alt"></i><span data-i18n="navCalendar">Lịch</span></a>
    <a href="#" class="nav-item" onclick="switchScreen('stats')"><i class="fas fa-calculator"></i><span data-i18n="navStats">Thống kê</span></a>
    <a href="#" class="nav-item" onclick="switchScreen('settings')"><i class="fas fa-cog"></i><span data-i18n="navSettings">Cài đặt</span></a>
</nav>

<div id="shiftModal" class="modal">
    <div class="modal-content">
        <h3 id="modalDate" style="text-align:center;"></h3>
        <div class="form-group">
            <label data-i18n="startTime">Bắt đầu</label>
            <input type="time" id="startTimeInput">
        </div>
        <div class="form-group">
            <label data-i18n="endTime">Kết thúc</label>
            <input type="time" id="endTimeInput">
        </div>
        <div class="form-group">
            <label data-i18n="breakTime">Nghỉ (phút)</label>
            <input type="number" id="breakTimeInput">
        </div>
        <div class="form-group">
            <label data-i18n="memo">Ghi chú</label>
            <textarea id="memoInput" rows="3"></textarea>
        </div>
        <div class="btn-group">
            <button class="btn btn-save" id="saveShift" data-i18n="save">Lưu</button>
            <button class="btn btn-delete" id="deleteShift" data-i18n="delete">Xóa</button>
            <button class="btn btn-cancel" onclick="document.getElementById('shiftModal').style.display='none'" data-i18n="cancel">Hủy</button>
        </div>
    </div>
</div>

<script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').then(reg => console.log('SW Registered!'));
        });
    }

    let shiftData = JSON.parse(localStorage.getItem('shiftData')) || {};
    let appSettings = JSON.parse(localStorage.getItem('appSettings')) || { defaultWage: 1100, nightWage: 25, overtimeWage: 1.25, nightStart: '22:00', nightEnd: '05:00' };
    let currentLang = localStorage.getItem('language') || 'vi';
    let currentYear = new Date().getFullYear(), currentMonth = new Date().getMonth();
    let selectedDate = new Date().toISOString().split('T')[0];

    const translations = {
        vi: { appTitle: "Quản lý ca làm", navCalendar: "Lịch", navStats: "Thống kê", navSettings: "Cài đặt", settings: "Cài đặt", monthlyStats: "Thống kê tháng", hourlyWage: "Lương cơ bản", startTime: "Bắt đầu", endTime: "Kết thúc", breakTime: "Nghỉ (phút)", save: "Lưu", delete: "Xóa", cancel: "Hủy", totalWage: "Tổng lương", totalHours: "Tổng giờ", darkMode: "Chế độ tối", language: "Ngôn ngữ", noShift: "Chưa có ca làm", editMemo: "Sửa", memo: "Ghi chú", nightWage: "Ca đêm (+%)" },
        ja: { appTitle: "シフト管理", navCalendar: "カレンダー", navStats: "統計", navSettings: "設定", settings: "設定", monthlyStats: "月間統計", hourlyWage: "時給", startTime: "開始", endTime: "終了", breakTime: "休憩", save: "保存", delete: "削除", cancel: "キャンセル", totalWage: "合計給与", totalHours: "合計時間", darkMode: "ダークモード", language: "言語", noShift: "シフトなし", editMemo: "編集", memo: "メモ", nightWage: "深夜手当" },
        en: { appTitle: "Shift Manager", navCalendar: "Calendar", navStats: "Stats", navSettings: "Settings", settings: "Settings", monthlyStats: "Stats", hourlyWage: "Base Wage", startTime: "Start", endTime: "End", breakTime: "Break", save: "Save", delete: "Delete", cancel: "Cancel", totalWage: "Total Wage", totalHours: "Total Hours", darkMode: "Dark Mode", language: "Language", noShift: "No shift", editMemo: "Edit", memo: "Memo", nightWage: "Night Bonus" }
    };

    function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[currentLang][key]) el.innerText = translations[currentLang][key];
        });
    }

    function calculateExactWage(s) {
        const start = s.start.split(':').map(Number), end = s.end.split(':').map(Number);
        let sMin = start[0]*60 + start[1], eMin = end[0]*60 + end[1];
        if(eMin < sMin) eMin += 1440;
        
        const totalMin = eMin - sMin;
        const nStart = 1320, nEnd = 300; // 22:00 to 05:00
        let nMin = 0;
        for(let m=sMin; m<eMin; m++) {
            let curr = m % 1440;
            if(curr >= nStart || curr < nEnd) nMin++;
        }
        
        const netTotal = totalMin - s.break;
        const netNight = nMin * (netTotal / totalMin);
        const basePay = netTotal * (appSettings.defaultWage / 60);
        const nightExtra = netNight * (appSettings.defaultWage * (appSettings.nightWage/100) / 60);
        return Math.round(basePay + nightExtra);
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        document.getElementById('calendarTitle').innerText = `${currentYear}/${currentMonth + 1}`;

        for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day' + (dateStr === selectedDate ? ' selected-day' : '');
            dayDiv.innerHTML = `<div class="day-number">${d}</div>`;
            if (shiftData[dateStr]) {
                dayDiv.innerHTML += `<div class="shift-info">${shiftData[dateStr].start}</div>`;
                dayDiv.innerHTML += `<div class="wage-info">¥${calculateExactWage(shiftData[dateStr]).toLocaleString()}</div>`;
            }
            dayDiv.onclick = () => { selectedDate = dateStr; renderCalendar(); updateDetail(); };
            grid.appendChild(dayDiv);
        }
    }

    function updateDetail() {
        const s = shiftData[selectedDate];
        document.getElementById('selectedDateLabel').innerText = selectedDate;
        if(s) {
            document.getElementById('dayShiftText').innerText = `${s.start} - ${s.end} (¥${calculateExactWage(s).toLocaleString()})`;
            document.getElementById('dayMemoText').innerText = s.memo || "";
        } else {
            document.getElementById('dayShiftText').innerText = translations[currentLang].noShift;
            document.getElementById('dayMemoText').innerText = "";
        }
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id + '-screen').classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(id === 'stats') updateStats();
    }

    function updateStats() {
        let totalW = 0, totalH = 0;
        Object.keys(shiftData).forEach(d => {
            if(d.startsWith(`${currentYear}-${String(currentMonth+1).padStart(2,'0')}`)) {
                totalW += calculateExactWage(shiftData[d]);
                const s = shiftData[d];
                const start = s.start.split(':').map(Number), end = s.end.split(':').map(Number);
                let dur = (end[0]*60+end[1]) - (start[0]*60+start[1]);
                if(dur < 0) dur += 1440;
                totalH += (dur - s.break)/60;
            }
        });
        document.getElementById('statsContent').innerHTML = `<b>${translations[currentLang].totalWage}:</b> ¥${totalW.toLocaleString()}<br><b>${translations[currentLang].totalHours}:</b> ${totalH.toFixed(2)}h`;
    }

    function openModalFromDetail() {
        const s = shiftData[selectedDate] || { start: "09:00", end: "17:00", break: 60, memo: "" };
        document.getElementById('modalDate').innerText = selectedDate;
        document.getElementById('startTimeInput').value = s.start;
        document.getElementById('endTimeInput').value = s.end;
        document.getElementById('breakTimeInput').value = s.break;
        document.getElementById('memoInput').value = s.memo;
        document.getElementById('shiftModal').style.display = 'block';
    }

    document.getElementById('saveShift').onclick = () => {
        shiftData[selectedDate] = {
            start: document.getElementById('startTimeInput').value,
            end: document.getElementById('endTimeInput').value,
            break: parseInt(document.getElementById('breakTimeInput').value),
            memo: document.getElementById('memoInput').value
        };
        localStorage.setItem('shiftData', JSON.stringify(shiftData));
        document.getElementById('shiftModal').style.display = 'none';
        renderCalendar(); updateDetail();
    };

    document.getElementById('deleteShift').onclick = () => { delete shiftData[selectedDate]; localStorage.setItem('shiftData', JSON.stringify(shiftData)); document.getElementById('shiftModal').style.display = 'none'; renderCalendar(); updateDetail(); };
    
    function appendCalc(v) { const d = document.getElementById('calcDisplay'); if(v==='C') d.value=''; else d.value+=v; }
    function calculateResult() { const d = document.getElementById('calcDisplay'); try { d.value = eval(d.value.replace(/×/g,'*').replace(/÷/g,'/')); } catch { d.value='Error'; } }

    window.onload = () => {
        document.getElementById('langSelect').value = currentLang;
        document.getElementById('langSelect').onchange = (e) => { currentLang = e.target.value; localStorage.setItem('language', currentLang); applyTranslations(); renderCalendar(); };
        document.getElementById('darkModeToggle').onchange = (e) => { document.body.classList.toggle('dark-mode', e.target.checked); localStorage.setItem('dark-mode', e.target.checked); };
        if(localStorage.getItem('dark-mode') === 'true') { document.body.classList.add('dark-mode'); document.getElementById('darkModeToggle').checked = true; }
        document.getElementById('defaultWage').value = appSettings.defaultWage;
        document.getElementById('nightWage').value = appSettings.nightWage;
        
        document.getElementById('prevMonth').onclick = () => { currentMonth--; if(currentMonth<0){currentMonth=11; currentYear--;} renderCalendar(); };
        document.getElementById('nextMonth').onclick = () => { currentMonth++; if(currentMonth>11){currentMonth=0; currentYear++;} renderCalendar(); };

        applyTranslations(); renderCalendar(); updateDetail();
    };
    function saveSettings() {
        appSettings.defaultWage = parseInt(document.getElementById('defaultWage').value);
        appSettings.nightWage = parseInt(document.getElementById('nightWage').value);
        localStorage.setItem('appSettings', JSON.stringify(appSettings));
    }
</script>
</body>
</html>